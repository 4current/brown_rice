---
title: "White Rice vs. Brown Rice"
output: pdf_document
header-includes:
  - \usepackage{booktabs}
---

```{r global_options, R.options=knitr::opts_chunk$set(warning=FALSE, message=FALSE)}
```

In this report, I'm using data from https://fdc.nal.usda.gov/index.html to persent a comparison of the nutritional 
value of brown rice vs. white rice. For information on this API look here. https://fdc.nal.usda.gov/api-guide.html


My API key is stored in .Renviron in my home directory using .Renviron as
data_gov_api_key

Here are two functions written to fetch the information.

### Search Functions
```{r message=FALSE}
library(curl)
library(jsonlite)

get_food_data <- function(x) {
  # make sure to bookend with quotes
  x <- paste0("\"", x, "\"")
  get_food_url <- "https://api.nal.usda.gov/fdc/v1/foods/search"
  query_terms = c(
    paste("query", URLencode(x), sep = "="),
    paste("dataType", "Survey (FNDDS)", sep = "="),
    paste("pageSize", "200", sep = "=")
  )
  query_string = paste(query_terms, collapse = "&")
  url <- paste(get_food_url, query_string, sep = "?")
  # print(url)
  
  curl_h <- new_handle()
  handle_setheaders(curl_h, 'X-Api-Key' = Sys.getenv("data_gov_api_key") )
  con <- curl(url, handle = curl_h)
  out <- readLines(con)
  close(con)
  fromJSON(out)[[5]]
}

get_food_by_fdcId <- function(id) {
  get_food_url <- "https://api.nal.usda.gov/fdc/v1/food"
  url <- paste(get_food_url, id, sep = "/")
  # print(url)
  
  curl_h <- new_handle()
  handle_setheaders(curl_h, 'X-Api-Key' = Sys.getenv("data_gov_api_key") )
  con <- curl(url, handle = curl_h)
  out <- readLines(con)
  close(con)
  fromJSON(out)
}

```

### Retrieve Data
```{r  message=FALSE, warning=FALSE}
rice <- c(
  white="Rice, white, cooked, fat not added in cooking",
  brown="Rice, brown, cooked, fat not added in cooking"
)

shortNames <- c("white", "brown")
white.df <- get_food_data(rice["white"])
brown.df <- get_food_data(rice["brown"])

ids <- c(white.df$fdcId, brown.df$fdcId)

foodItems <- lapply(ids, get_food_by_fdcId)

```

### Initial Inputs
```{r}
library(dplyr)
library(kableExtra)

white_rice_ingredients <-  foodItems[[1]]$inputFoods %>%
  transmute(
    ingredient=ingredientDescription,
    portion=portionDescription,
    grams=ingredientWeight
    ) 
brown_rice_ingredients <-  foodItems[[2]]$inputFoods %>%
  transmute(
    ingredient=ingredientDescription,
    portion=portionDescription,
    grams=ingredientWeight
    )
```

```{r echo=FALSE, results='asis'}
library(knitr)
library(xtable)

t1 <- white_rice_ingredients %>%
  kable(format = "latex", booktabs = TRUE) %>%
  column_spec(1, width = "11em")
t2 <- brown_rice_ingredients %>%
  kable(format = "latex", booktabs = TRUE)  %>%
  column_spec(1, width = "11em")

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{White Rice Ingredients}",
        t1,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{Brown Rice Ingredients}",
        t2,
    "\\end{minipage} 
\\end{table}"
))

```

### Compare Nutrients
```{r echo=TRUE}
library(dplyr)
library(knitr)
library(xtable)

portions <- unlist(lapply(foodItems, function(x) {x$foodPortions$portionDescription[1]}))
names(portions) <- shortNames

white.nutrients.df <- white.df$foodNutrients[[1]] %>%
  transmute(nutrient=nutrientName,value,unit=unitName)

brown.nutrients.df <- brown.df$foodNutrients[[1]] %>%
  transmute(nutrient=nutrientName,value,unit=unitName)

combined.df <- full_join(
  white.nutrients.df, brown.nutrients.df, 
  by="nutrient", suffix=c(".white",".brown")
  ) %>%
  filter(
    unit.brown=="G" |
    unit.white == "G" |
    unit.brown == "KCAL" |
    unit.white == "KCAL"
  ) %>%
  filter(value.brown > 0, value.white > 0) %>%
  arrange(desc(value.white)) %>%
  rename(white=value.white, brown=value.brown) %>%
  select(nutrient, white, brown)

kable(combined.df, format = "latex", label="Table 3",
      caption="Nutrient List", booktabs = TRUE) 

```

### Calories
```{r}

compared.df <-data.frame(
  rbind(combined.df$white, combined.df$brown),
  row.names = shortNames)
names(compared.df) <- combined.df$nutrient

grams <- colSums(combined.df[2:6,2:3], na.rm=TRUE)
print(grams)

barplot(compared.df$Energy,  main = "Calories", names.arg=shortNames)
```

### Nutrients by Mass
```{r}
barplot(height=as.matrix(compared.df[,2:6]),names.arg=c("Water", "Carbohydrates", "Protein", "Fiber", "Lipids"), main="Nutrients", legend.text = shortNames, beside=TRUE, log = "y", args.legend = list(x = 'topright'))


```

